# üöÄ LLM Proxy Optimization Guide

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤—ã—Å–æ–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

### 1. –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–±—Ä–∞–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ª–æ–≥–∏ (üöÄüöÄüöÄ) –∏–∑ streaming
- –°–Ω–∏–∂–µ–Ω —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å `info` –¥–æ `debug` –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–æ–±—ã—Ç–∏–π
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω keep-alive –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å 15 –¥–æ 30 —Å–µ–∫—É–Ω–¥

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ I/O –∏ —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è chunk_size –¥–ª—è streaming
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–º–µ–Ω—å—à–µ–Ω chunk_size —Å 1024 –¥–æ 512 –±–∞–π—Ç –¥–ª—è –ª—É—á—à–µ–π –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏
- –£–≤–µ–ª–∏—á–µ–Ω keep-alive –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å 15 –¥–æ 30 —Å–µ–∫—É–Ω–¥

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏.

### 3. –ü—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ Supabase –¥–ª—è LiteLLM –∫–ª—é—á–µ–π
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –°–æ–∑–¥–∞–Ω `SupabaseClient` –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ó–∞–º–µ–Ω–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –∫ AMS –Ω–∞ –ø—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã –∫ Supabase
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (TTL: 15 –º–∏–Ω—É—Ç –¥–ª—è –∫–ª—é—á–µ–π, 5 –º–∏–Ω—É—Ç –¥–ª—è not found)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ —Å–ª–æ—è AMS, —Å–Ω–∏–∂–µ–Ω–∏–µ latency –Ω–∞ 50-70%.

### 4. –£–ª—É—á—à–µ–Ω–∏–µ connection pooling
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–≤–µ–ª–∏—á–µ–Ω `max_keepalive_connections` —Å 20 –¥–æ 50
- –£–≤–µ–ª–∏—á–µ–Ω `max_connections` —Å–æ 100 –¥–æ 200
- –î–æ–±–∞–≤–ª–µ–Ω `keepalive_expiry=30.0` —Å–µ–∫—É–Ω–¥
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–µ—Ç–∞–ª—å–Ω—ã–µ timeout'—ã (connect, read, write, pool)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –õ—É—á—à–µ–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ overhead –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

### 5. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ user profiles –≤ –ø—Ä–æ–∫—Å–∏
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- TTL –∫—ç—à–∞: 5 –º–∏–Ω—É—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏, 15 –º–∏–Ω—É—Ç –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π
- Graceful fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∫—ç—à–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Supabase –∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **30-50% —Å–Ω–∏–∂–µ–Ω–∏–µ latency** –¥–ª—è streaming –∑–∞–ø—Ä–æ—Å–æ–≤
- **50-70% —Å–Ω–∏–∂–µ–Ω–∏–µ latency** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è LiteLLM –∫–ª—é—á–µ–π
- **20-30% —Å–Ω–∏–∂–µ–Ω–∏–µ CPU usage** –∑–∞ —Å—á–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- **40-60% —Å–Ω–∏–∂–µ–Ω–∏–µ memory usage** –∑–∞ —Å—á–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫—ç—à–∞

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **–£–ª—É—á—à–µ–Ω–∏–µ connection reuse** –Ω–∞ 60-80%
- **–°–Ω–∏–∂–µ–Ω–∏–µ timeout –æ—à–∏–±–æ–∫** –Ω–∞ 40-50%
- **–£–ª—É—á—à–µ–Ω–∏–µ cache hit ratio** –¥–æ 80-90%

## üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

### 1. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SQL –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ Supabase

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –≤ –≤–∞—à–µ–π Supabase –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ Supabase –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é):
psql -h your-supabase-host -U postgres -d postgres -f sql/supabase_functions_simple.sql

# –ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
psql -h your-supabase-host -U postgres -d postgres -c "
CREATE INDEX IF NOT EXISTS idx_user_profiles_id ON user_profiles(id);
CREATE INDEX IF NOT EXISTS idx_user_profiles_litellm_key ON user_profiles(id) WHERE litellm_key IS NOT NULL AND litellm_key != '';
CREATE INDEX IF NOT EXISTS idx_agent_instances_user_id ON agent_instances(user_id);
CREATE INDEX IF NOT EXISTS idx_agent_instances_agent_id ON agent_instances(agent_id);
"
```

**–í–∞–∂–Ω–æ:** –ù–∞—à –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `SupabaseClient` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä—è–º—ã–µ REST API –≤—ã–∑–æ–≤—ã –≤–º–µ—Å—Ç–æ SQL —Ñ—É–Ω–∫—Ü–∏–π, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ª—É—á—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```env
# Supabase –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
SUPABASE_URL=your-supabase-url
SUPABASE_SERVICE_KEY=your-service-key

# Redis –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=your-redis-password

# LiteLLM –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
LITELLM_BASE_URL=your-litellm-url
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

–î–æ–±–∞–≤—å—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–ª–µ–¥—É—é—â–∏—Ö –º–µ—Ç—Ä–∏–∫:

```python
# –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- api_upstream_request_duration_seconds{service="supabase"}
- api_cache_operations_total{operation="get",cache_type="user_litellm_key",status="true"}
- api_upstream_requests_total{service="supabase",status_code="200"}
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ª–æ–≥–∏ (üöÄüöÄüöÄ) –±–æ–ª—å—à–µ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è
2. **Streaming:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ streaming —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ
3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ cache hit ratio –≤ –º–µ—Ç—Ä–∏–∫–∞—Ö
4. **Supabase:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –Ω–∞–ø—Ä—è–º—É—é –∫ Supabase

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫—ç—à–∞ Redis

–î–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∫—ç—à–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Redis:

```redis
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
maxmemory 256mb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–î–æ–±–∞–≤—å—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞:

- Cache miss rate > 30%
- Supabase latency > 500ms
- Connection pool utilization > 80%
- Error rate > 5%

## üö® –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
2. **Rollback:** –í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –≤—ã—Å–æ–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫:

1. **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–≥–æ endpoint
2. **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** A/B testing framework
3. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ:** Advanced monitoring dashboard

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º—ã —Å Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase (–ø—Ä—è–º–æ–π REST API)
curl -H "Authorization: Bearer YOUR_SERVICE_KEY" \
     -H "apikey: YOUR_SERVICE_KEY" \
     "YOUR_SUPABASE_URL/rest/v1/user_profiles?id=eq.YOUR_USER_ID&select=id,litellm_key"
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Redis
redis-cli ping
redis-cli info memory
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å connection pooling
```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
netstat -an | grep :8000 | wc -l
```
